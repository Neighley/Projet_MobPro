@model IEnumerable<Projet_MobPro.Models.T_offre_emploi>
@using Microsoft.AspNet.Identity

@{
    ViewBag.Title = "Index";
}

<h2>Voir les offres d'emploi</h2>

<p>
    @if (ViewBag.CurrentUserRoleId == 1)
    {
        @Html.ActionLink("Créer une offre", "Create")
    }
</p>

<div class="row">
    @foreach (var item in Model)
    {
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">@item.nom</h5>
                    <h6 class="card-subtitle mb-2 text-muted">Entreprise : @item.T_entreprise.nom</h6>
                    <p class="card-text">
                        <small>
                            <i class="fas fa-map-marker-alt"></i> @item.T_site.adresse, @item.T_site.code_postal @item.T_site.ville<br>
                            <i class="fas fa-calendar-alt"></i><a href="@item.url_site" target="_blank">@item.url_site</a><br />
                            <i class="fas fa-calendar-alt"></i> Publié le @item.date_publication.Value.ToString("dd/MM/yyyy")
                        </small>
                    </p>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <i class="fas fa-globe"></i> Recherche : @item.T_type_contrat.nom_type_contrat
                        </li>
                        <li class="list-group-item">
                            <i class="fas fa-globe"></i> Ouvert à l'externe : @(item.ouvert_externe.GetValueOrDefault() ? "Oui" : "Non")
                        </li>
                        <li class="list-group-item">
                            <i class="fas fa-home"></i> Télétravail : @(item.teletravail_autorise.GetValueOrDefault() ? "Autorisé" : "Non autorisé")
                        </li>
                        <li class="list-group-item">
                            <i class="fas fa-laptop-house"></i> Télétravail à temps plein : @(item.full_teletravail.GetValueOrDefault() ? "Oui" : "Non")
                        </li>
                    </ul>
                    @if (User.Identity.IsAuthenticated)
                    {
                        <div class="mt-2">
                            <button onclick="calculateDistance(@item.id)" class="btn btn-info btn-sm">Calculer la distance</button>
                            <div id="distanceResult-@item.id" style="display:none;">
                                Distance : <span id="distance-@item.id"></span> km
                            </div>
                        </div>
                    }
                </div>
                <div class="card-footer bg-transparent">
                    <small class="text-muted" style="color: #6c757d;">Statut : @item.T_statut.statut</small>
                    <div class="mt-2">
                        @Html.ActionLink("Contact", "Contact", new { id = item.id }, new { @class = "btn btn-primary btn-spacing" })
                        @Html.ActionLink("Détails", "Details_Requis", new { id = item.id }, new { @class = "btn btn-custom-edit btn-spacing" })

                        @if (ViewBag.CurrentUserRoleId == 1)
                        {
                            <br />
                            @Html.ActionLink("Modifier", "Edit", new { id = item.id }, new { @class = "btn btn-custom-edit btn-spacing" })
                            @Html.ActionLink("Supprimer", "Delete", new { id = item.id }, new { @class = "btn btn-custom-delete btn-spacing" })
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        function calculateDistance(offreId) {
            $.ajax({
                url: '@Url.Action("CalculateDistance", "VotreController")',
                type: 'GET',
                data: { offreId: offreId },
                success: function (result) {
                    if (result.success) {
                        $('#distance-' + offreId).text((result.distance / 1000).toFixed(2));
                        $('#distanceResult-' + offreId).show();
                    } else {
                        alert(result.message);
                    }
                },
                error: function () {
                    alert('Une erreur est survenue lors du calcul de la distance.');
                }
            });
        }
    </script>
}